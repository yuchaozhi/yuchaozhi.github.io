<meta charset="utf-8">

{% include seo.html %}

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="assets/css/main.css">

<meta http-equiv="cleartype" content="on">
<head>
  <base target="_blank">
</head>

<script>
// BibTeX functionality
function toggleBibtex(id) {
  var content = document.getElementById(id);
  if (content.style.display === 'none') {
    content.style.display = 'block';
  } else {
    content.style.display = 'none';
  }
}

function copyBibtex(id) {
  var content = document.getElementById(id);
  var pre = content.querySelector('pre');
  var text = pre.textContent;
  
  // Create a temporary textarea element
  var textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    // Copy the text to clipboard
    document.execCommand('copy');
    
    // Show feedback to user
    var copyBtn = content.querySelector('.copy-btn');
    var originalText = copyBtn.textContent;
    copyBtn.textContent = '已复制!';
    copyBtn.style.backgroundColor = '#6c757d';
    
    // Reset button after 2 seconds
    setTimeout(function() {
      copyBtn.textContent = originalText;
      copyBtn.style.backgroundColor = '#28a745';
    }, 2000);
    
  } catch (err) {
    console.error('Failed to copy text: ', err);
    alert('复制失败，请手动复制');
  }
  
  // Remove the temporary textarea
  document.body.removeChild(textarea);
}

// BibTeX database - 从 reference.bib 文件动态加载
var bibtexDatabase = {};

// 解析 BibTeX 条目的函数
function parseBibtexEntry(text) {
  var lines = text.split('\n');
  var result = {};
  var currentField = '';
  var currentValue = '';
  var inValue = false;
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    
    if (line === '') continue;
    
    // 处理字段定义
    var fieldMatch = line.match(/^(\w+)\s*=\s*\{?(.+?)\}?\,?$/);
    if (fieldMatch) {
      var fieldName = fieldMatch[1];
      var fieldValue = fieldMatch[2];
      result[fieldName] = fieldValue;
    }
  }
  
  return result;
}

// 从 reference.bib 文件加载 BibTeX 数据
function loadBibtexFromFile() {
  fetch('/reference.bib')
    .then(response => response.text())
    .then(data => {
      // 解析 BibTeX 文件
      var entries = data.split(/@\w+\{/);
      
      for (var i = 1; i < entries.length; i++) {
        var entry = entries[i];
        var keyMatch = entry.match(/^([^,]+),/);
        if (keyMatch) {
          var key = keyMatch[1].trim();
          var fields = {};
          
          // 提取各个字段
          var fieldMatches = entry.match(/(\w+)\s*=\s*\{([^}]+)\}/g);
          if (fieldMatches) {
            fieldMatches.forEach(function(match) {
              var fieldMatch = match.match(/(\w+)\s*=\s*\{([^}]+)\}/);
              if (fieldMatch) {
                fields[fieldMatch[1]] = fieldMatch[2];
              }
            });
          }
          
          // 重建 BibTeX 字符串
          var entryTypeMatch = entries[i-1].match(/@(\w+)\{/);
          var entryType = entryTypeMatch ? entryTypeMatch[1] : 'article';
          var bibtexStr = '@' + entryType + '{' + key + ',\n';
          for (var fieldName in fields) {
            bibtexStr += '  ' + fieldName + '={' + fields[fieldName] + '},\n';
          }
          bibtexStr += '}';
          
          bibtexDatabase[key] = bibtexStr;
        }
      }
      
      console.log('BibTeX 数据加载完成，共加载 ' + Object.keys(bibtexDatabase).length + ' 条条目');
      
      // 重新处理页面上的引用
      processCitations();
    })
    .catch(error => {
      console.error('加载 reference.bib 文件失败:', error);
    });
}

// Process \cite{} references when page loads
document.addEventListener('DOMContentLoaded', function() {
  // 首先尝试从 reference.bib 文件加载数据
  loadBibtexFromFile();
});

// 处理引用的函数
function processCitations() {
  // Find all text nodes containing \cite{...}
  var walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    null,
    false
  );
  
  var textNodes = [];
  var node;
  while (node = walker.nextNode()) {
    if (node.textContent.includes('\\cite{')) {
      textNodes.push(node);
    }
  }
  
  // Process each text node
  textNodes.forEach(function(textNode) {
    var text = textNode.textContent;
    var parent = textNode.parentNode;
    
    // Replace \cite{key} with BibTeX button
    var citeRegex = /\\cite\{([^}]+)\}/g;
    var newHTML = text.replace(citeRegex, function(match, key) {
      if (bibtexDatabase[key]) {
        var uniqueId = 'bibtex-' + key + '-' + Math.random().toString(36).substr(2, 9);
        return '<button class="bibtex-btn" onclick="toggleBibtex(\'' + uniqueId + '\')">BibTeX</button>' +
               '<div id="' + uniqueId + '" class="bibtex-content" style="display: none;">' +
               '<pre>' + bibtexDatabase[key] + '</pre>' +
               '<button class="copy-btn" onclick="copyBibtex(\'' + uniqueId + '\')">复制</button>' +
               '</div>';
      }
      return match; // Keep original if key not found
    });
    
    if (newHTML !== text) {
      var tempDiv = document.createElement('div');
      tempDiv.innerHTML = newHTML;
      while (tempDiv.firstChild) {
        parent.insertBefore(tempDiv.firstChild, textNode);
      }
      parent.removeChild(textNode);
    }
  });
}
</script>